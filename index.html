<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tracktion Benchmarks</title>
  <style>
    body      { background-color: white; }
    #charts   { max-width: 1000px; }
    select    { max-width: 250px; margin-right: 20px; }
    .tickboxes  { padding-right: 30px; }
  </style>
  </head>
<body onload="update()">
  <h1>Tracktion Benchmarks</h1>

  <label for="categories_list">Categories:</label>
  <select id="categories_list" oninput="update();"></select>

  <label for="names_list">Name:</label>
  <select id="names_list" oninput="update();"></select>

  <label for="descriptions_list">Description:</label>
  <select id="descriptions_list" oninput="update();"></select>

  <label for="platforms_list">Platform:</label>
  <select id="platforms_list" oninput="update();"></select>
  
  <br/><br/>
  <input type="checkbox" id="show_total_button" name="total_name" checked oninput="update();">
  <label class="tickboxes" for="total_name">Show total</label>

  <input type="checkbox" id="show_minmax_button" name="minmax_name" checked oninput="update();">
  <label class="tickboxes" for="minmax_name">Show min/max</label>

  <input type="checkbox" id="show_variance_button" name="variance_name" oninput="update();">
  <label class="tickboxes"for="variance_name">Show variance</label>

  <br/><br/>
  <hr/>
  <br/>
  
  <div id="charts"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
  <script type="text/javascript" src="benchmarks.js"></script>
  <script>
    const allBenchmarks = JSON.parse (benchmarks);
    
    var categoryToShow;
    var nameToShow;
    var descriptionToShow;
    var platformToShow;
    var showTotal;
    var showMinMaxMean;
    var showVariances;

    var hashes = new Set();
    var categories = new Set();
    var names = new Set();
    var descriptions = new Set();
    var platforms = new Set();
    var hashAndFields = new Map();

    function Values()
    {
      var dateTimes = [];
      var durations = [];
      var minimums = [];
      var maximums = [];
      var means = [];
      var variances = [];
    };
    var hashAndValues = new Map();

    buildSets();
    updateMenus();

    function buildSets()
    {
      allBenchmarks.forEach (element =>
      {
        let hash = element.benchmark_hash;
        hashes.add (hash);
        categories.add (element.benchmark_category);
        names.add (element.benchmark_name);
        descriptions.add (element.benchmark_description);
        platforms.add (element.benchmark_platform);

        if (! Array.isArray (hashAndFields.get (hash)))
          hashAndFields.set (hash, []);

        hashAndFields.get (hash).push (element);

        if (! hashAndValues.get (hash))
          hashAndValues.set (hash, new Values());

        var values = hashAndValues.get (hash);

        if (! values.category)    values.category     = element.benchmark_category;
        if (! values.name)        values.name         = element.benchmark_name;
        if (! values.description) values.description  = element.benchmark_description;
        if (! values.platform)    values.platform     = element.benchmark_platform;

        if (! values.dateTimes)   values.dateTimes    = new Array();
        if (! values.durations)   values.durations    = new Array();
        if (! values.minimums)    values.minimums     = new Array();
        if (! values.maximums)    values.maximums     = new Array();
        if (! values.means)       values.means        = new Array();
        if (! values.variances)   values.variances    = new Array();
        
        values.dateTimes.push (element.benchmark_time);
        values.durations.push (element.benchmark_duration);
        // values.minimums.push (element.benchmark_duration * 0.9); // Test data
        // values.maximums.push (element.benchmark_duration * 1.1);
        // values.variances.push (element.benchmark_duration * 0.5);
        values.minimums.push (element.benchmark_duration_min);
        values.maximums.push (element.benchmark_duration_max);
        values.means.push (element.benchmark_duration_mean);        
        values.variances.push (element.benchmark_duration_variance);
      });
    }

    function updateMenus()
    {
      categories_list.innerHTML = "";
      names_list.innerHTML = "";
      descriptions_list.innerHTML = "";
      platforms_list.innerHTML = "";

      function populateOptions (list, menuItems)
      {
        list.innerHTML = "";

        var option = document.createElement ('option');
        option.value = "All";
        option.innerHTML = option.value;
        list.appendChild (option);

        menuItems.forEach (menuItem =>
        {
          var option = document.createElement ('option');
          option.value = menuItem;
          option.innerHTML = option.value;
          list.appendChild (option);
        });
      };

      populateOptions (categories_list, categories);
      populateOptions (names_list, names);
      populateOptions (descriptions_list, descriptions);
      populateOptions (platforms_list, platforms);
    }

    function addChart (hash, values)
    {
      const title = values.name + ' (' + values.platform + ')';
      const subtitle = values.description;

      var canvas = document.createElement ('canvas');
      canvas.id = hash;
      canvas.style="width:100%";
      charts.appendChild (canvas);

      const red     = 'rgb(255, 99, 132)';
      const orange  = 'rgb(255, 159, 64)';
      const yellow  = 'rgb(255, 205, 86)';
      const green   = 'rgb(75, 192, 192)';
      const blue    = 'rgb(54, 162, 235)';
      const purple  = 'rgb(153, 102, 255)';
      const grey    = 'rgb(201, 203, 207)';
      const transparent         = '#00000000';
      const translucentYellow   = '#ffcd5644';
      const translucentBlue     = '#36a2eb11';
      const lightBlue           = '#36a2ebaa';

      var scales = {
            y: {},
          };

      var datasets = [];

      if (showTotal)
      {
        datasets.push ({ label: 'Duration', data: values.durations, lineTension: 0, backgroundColor: blue, borderColor: blue  });
      }

      if (showMinMaxMean)
      {
        datasets.push ({ label: 'Min', data: values.minimums, lineTension: 0, backgroundColor: translucentBlue, borderColor: green, fill: '+1' });
        datasets.push ({ label: 'Max', data: values.maximums, lineTension: 0, backgroundColor: translucentBlue, borderColor: red });
        datasets.push ({ label: 'Mean', data: values.means, lineTension: 0, backgroundColor: translucentBlue, borderColor: lightBlue });
      }

      if (showVariances)
      {
        datasets.push ({ label: 'Var', data: values.variances, lineTension: 0, backgroundColor: purple, borderColor: purple, yAxisID: 'varianceScale' });
        scales.varianceScale =
          {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false, // only want the grid lines for one axis to show up
            },
          };
      }

      var chart = new Chart (canvas.id, {
        type: "line",
        data: {
          labels: values.dateTimes,
          datasets
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: [ title ]
          },
          scales,
          interaction: {
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: title,
            },
            subtitle: {
              display: true,
              text: subtitle,
              font: {
                size: 12,
                style: 'italic'
              },
              padding: {
                bottom: 10
              }
            },
            filler: {
              propagate: false
            },
            'samples-filler-analyser': {
              target: 'chart-analyser'
            }
          },
        }
      });
    }

    function update()
    {
      categoryToShow    = categories_list.value;
      nameToShow        = names_list.value;
      descriptionToShow = descriptions_list.value;
      platformToShow    = platforms_list.value;
      showTotal         = show_total_button.checked;
      showMinMaxMean    = show_minmax_button.checked;
      showVariances     = show_variance_button.checked;

      charts.innerHTML = "";

      hashAndValues.forEach (function (values, hash)
      {
        if ((categoryToShow == "All" || categoryToShow == values.category)
            && (nameToShow == "All" || nameToShow == values.name)
            && (descriptionToShow == "All" || descriptionToShow == values.description)
            && (platformToShow == "All" || platformToShow == values.platform))
        {
          addChart (hash, values);
        }
      });
    }
  </script>
</body>
</html>
